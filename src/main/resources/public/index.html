<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Image Duplicate Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            color: #666;
        }

        .stat {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .cluster {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .cluster-id {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .cluster-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-keep-all {
            background: #4CAF50;
            color: white;
        }

        .btn-keep-all:hover {
            background: #45a049;
        }

        .btn-delete-all {
            background: #f44336;
            color: white;
        }

        .btn-delete-all:hover {
            background: #da190b;
        }

        .btn-auto {
            background: #2196F3;
            color: white;
        }

        .btn-auto:hover {
            background: #0b7dda;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .image-item {
            position: relative;
            border: 3px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .image-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .image-item.keep {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .image-item.delete {
            border-color: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.3);
            opacity: 0.7;
        }

        .image-wrapper {
            width: 100%;
            height: 250px;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-info {
            padding: 10px;
            background: #fafafa;
        }

        .image-path {
            font-size: 11px;
            color: #666;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .image-actions {
            display: flex;
            gap: 5px;
            justify-content: space-between;
        }

        .action-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .action-badge.keep {
            background: #4CAF50;
            color: white;
        }

        .action-badge.delete {
            background: #f44336;
            color: white;
        }

        .reason {
            font-size: 10px;
            color: #999;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .save-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }

        .save-panel.show {
            display: block;
        }

        .btn-save {
            background: #FF9800;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-save:hover {
            background: #F57C00;
        }

        .original-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #2196F3; /* Blue background */
            color: white; /* White text */
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* A generic darker shadow */
            z-index: 10;
            max-width: 200px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

    </style>
</head>
<body>
<header>
    <h1>Image Duplicate Finder</h1>
    <div class="stats">
        <div class="stat">Clusters: <strong id="clusterCount">0</strong></div>
        <div class="stat">Total Images: <strong id="imageCount">0</strong></div>
        <div class="stat">To Keep: <strong id="keepCount">0</strong></div>
        <div class="stat">To Delete: <strong id="deleteCount">0</strong></div>
    </div>
</header>

<div id="error"></div>
<div id="loading" class="loading">Loading clusters...</div>
<div id="clusters"></div>

<div id="savePanel" class="save-panel">
    <button class="btn btn-save" onclick="savePlan()">Save Changes</button>
</div>

<script>
    let planData = {};
    let clustersData = {}; // Add this
    let hasChanges = false;

    async function loadData() {
        try {
            const [plan, clusters] = await Promise.all([
                fetch('/api/plan').then(r => r.json()),
                fetch('/api/clusters').then(r => r.json())
            ]);

            // Build plan map
            plan.forEach(item => {
                const key = `${item.clusterId}:${item.path}`;
                planData[key] = item;
            });

            // Build clusters map with file metadata
            clusters.forEach(cluster => {
                clustersData[cluster.id] = cluster.files || cluster.paths?.map(p => ({ path: p, size: 0, modified: 0 }));
            });

            renderClusters(clusters);
            updateStats();
            document.getElementById('loading').style.display = 'none';
        } catch (error) {
            showError('Failed to load data: ' + error.message);
            document.getElementById('loading').style.display = 'none';
        }
    }



    function setAllAction(clusterId, action) {
        const files = clustersData[clusterId];
        if (!files) return;

        files.forEach(file => {
            const path = file.path || file;
            const key = `${clusterId}:${path}`;
            if (!planData[key]) {
                planData[key] = { clusterId, path, action: 'keep', reason: '' };
            }
            planData[key].action = action;
            planData[key].reason = `Set all to ${action}`;
        });

        markChanged();
        renderImages(clusterId, files);
        updateStats();
    }

    function autoSelect(clusterId) {
        const files = clustersData[clusterId];
        if (!files) return;

        // Find largest file
        let largestIndex = 0;
        let maxSize = 0;
        files.forEach((file, index) => {
            if (file.size > maxSize) {
                maxSize = file.size;
                largestIndex = index;
            }
        });

        files.forEach((file, index) => {
            const path = file.path || file;
            const key = `${clusterId}:${path}`;
            if (!planData[key]) {
                planData[key] = { clusterId, path, action: 'keep', reason: '' };
            }
            planData[key].action = index === largestIndex ? 'keep' : 'delete';
            planData[key].reason = index === largestIndex ? 'Largest file kept' : 'Smaller duplicate removed';
        });

        markChanged();
        renderImages(clusterId, files);
        updateStats();
    }

    function toggleAction(clusterId, path) {
        const key = `${clusterId}:${path}`;
        const item = planData[key] || { clusterId, path, action: 'keep', reason: '' };

        item.action = item.action === 'keep' ? 'delete' : 'keep';
        item.reason = 'Manual selection';
        planData[key] = item;

        markChanged();

        const files = clustersData[clusterId];
        if (files) {
            renderImages(clusterId, files);
        }
        updateStats();
    }

    function renderClusters(clusters) {
        const container = document.getElementById('clusters');
        container.innerHTML = '';

        clusters.forEach(cluster => {
            const files = clustersData[cluster.id] || [];
            const clusterDiv = document.createElement('div');
            clusterDiv.className = 'cluster';
            clusterDiv.innerHTML = `
            <div class="cluster-header">
                <div class="cluster-id">Cluster ${cluster.id} (${files.length} images)</div>
                <div class="cluster-actions">
                    <button class="btn btn-auto" onclick="autoSelect('${cluster.id}')">Auto Select</button>
                    <button class="btn btn-keep-all" onclick="setAllAction('${cluster.id}', 'keep')">Keep All</button>
                    <button class="btn btn-delete-all" onclick="setAllAction('${cluster.id}', 'delete')">Delete All</button>
                </div>
            </div>
            <div class="image-grid" id="cluster-${cluster.id}"></div>
        `;
            container.appendChild(clusterDiv);

            renderImages(cluster.id, files);
        });
    }




    function renderImages(clusterId, files) {
        const grid = document.getElementById(`cluster-${clusterId}`);
        grid.innerHTML = '';

        // Determine likely original (largest file size)
        let likelyOriginalIndex = 0;
        let maxSize = 0;
        let originalReason = '';

        files.forEach((file, index) => {
            const size = file.size || 0;
            if (size > maxSize) {
                maxSize = size;
                likelyOriginalIndex = index;
            }
        });

        if (maxSize > 0) {
            const sizeMB = (maxSize / 1024 / 1024).toFixed(2);
            if (sizeMB === '0.00') {
                const sizeKB = (maxSize / 1024).toFixed(0);
                originalReason = `Largest file (${sizeKB} KB)`;
            } else {
                originalReason = `Largest file (${sizeMB} MB)`;
            }
        }

        files.forEach((file, index) => {
            const path = file.path || file;
            const key = `${clusterId}:${path}`;
            const item = planData[key] || { action: 'keep', reason: '' };

            const imgDiv = document.createElement('div');
            imgDiv.className = `image-item ${item.action}`;
            imgDiv.onclick = () => toggleAction(clusterId, path);

            const encodedPath = encodeURIComponent(path);
            const isLikelyOriginal = index === likelyOriginalIndex && maxSize > 0;

            imgDiv.innerHTML = `
            <div class="image-wrapper">
                ${isLikelyOriginal ? `<div class="original-badge">‚≠ê ${originalReason}</div>` : ''}
                <img src="/api/image?path=${encodedPath}" alt="${path}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Ctext x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3ENo Preview%3C/text%3E%3C/svg%3E'">
            </div>
            <div class="image-info">
                <div class="image-path">${path.split(/[\\/]/).pop()}</div>
                <div class="image-actions">
                    <span class="action-badge ${item.action}">${item.action.toUpperCase()}</span>
                    ${item.reason ? `<span class="reason">${item.reason}</span>` : ''}
                </div>
            </div>
        `;
            grid.appendChild(imgDiv);
        });
    }


    function setAction(clusterId, path, action) {
        const key = `${clusterId}:${path}`;

        console.log('setAction called:', {key, action, before: planData[key]}); // Debug

        if (!planData[key]) {
            planData[key] = { clusterId, path, action: 'keep', reason: '' };
        }

        planData[key].action = action;

        console.log('After update:', planData[key]); // Debug

        markChanged();
        renderImages(clusterId, [path]);
        updateStats();
    }

    async function savePlan() {
        try {
            const planArray = Object.values(planData);

            console.log('planData object:', planData); // Debug: see the object
            console.log('planArray to send:', planArray); // Debug: see the array
            console.log('JSON string:', JSON.stringify(planArray)); // Debug: see actual JSON

            const response = await fetch('/api/plan/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(planArray)
            });

            if (response.ok) {
                hasChanges = false;
                document.getElementById('savePanel').classList.remove('show');
                alert('Plan saved successfully!');
            } else {
                throw new Error('Failed to save');
            }
        } catch (error) {
            console.error('Save error:', error);
            showError('Failed to save plan: ' + error.message);
        }
    }


    function markChanged() {
        hasChanges = true;
        document.getElementById('savePanel').classList.add('show');
    }

    function updateStats() {
        const allItems = Object.values(planData);
        const clusters = new Set(allItems.map(i => i.clusterId)).size;
        const keeps = allItems.filter(i => i.action === 'keep').length;
        const deletes = allItems.filter(i => i.action === 'delete').length;

        document.getElementById('clusterCount').textContent = clusters;
        document.getElementById('imageCount').textContent = allItems.length;
        document.getElementById('keepCount').textContent = keeps;
        document.getElementById('deleteCount').textContent = deletes;
    }

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
    }

    window.debugPlanData = function() {
        console.log('Current planData:', planData);
        console.log('Total entries:', Object.keys(planData).length);
        Object.entries(planData).forEach(([key, value]) => {
            console.log(key, ':', value);
        });
    };

    loadData();
</script>
</body>
</html>
